apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ingress
  namespace: default
spec:
  ingressClassName: nginx
  rules:
    # Rule for help-service.local (if you want to access it directly via its own domain)
    - host: help-service.local
      http:
        paths:
          - path: / # Route all requests to the help-service
            pathType: Prefix
            backend:
              service:
                name: help-service
                port:
                  number: 3002

    # Rule for user-service.local (if you want to access it directly via its own domain)
    - host: user-service.local
      http:
        paths:
          - path: / # Route all requests to the user-service
            pathType: Prefix
            backend:
              service:
                name: user-service
                port:
                  number: 3000

    # Rule for frontend.local - This is where the magic happens for API routing
    - host: frontend.local
      http:
        annotations:
          nginx.ingress.kubernetes.io/use-regex: "true"
        paths:
          # Path for routing user-service API calls (e.g., frontend.local/api/users/login)
          # The regex (.*) captures everything after /api/users/
          # The rewrite-target: /$2 sends only the captured part to the backend (e.g., /login)
          - path: /api/users(/|$)(.*) # Matches /api/users or /api/users/anything
            pathType: ImplementationSpecific
            backend:
              service:
                name: user-service
                port:
                  number: 3000
            annotations:
              nginx.ingress.kubernetes.io/rewrite-target: /$2
          # Path for routing help-service API calls (e.g., frontend.local/api/help/tickets)
          # The regex (.*) captures everything after /api/help/
          # The rewrite-target: /$2 sends only the captured part to the backend (e.g., /tickets)
          - path: /api/help(/|$)(.*) # Matches /api/help or /api/help/anything
            pathType: ImplementationSpecific
            backend:
              service:
                name: help-service
                port:
                  number: 3002
            annotations:
              nginx.ingress.kubernetes.io/rewrite-target: /$2
          # Path for serving the frontend static files (the React app itself)
          # This must remain Prefix, as it's a simple prefix match, and for proper order.
          # It is placed last to ensure more specific API paths are matched first.
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 80
