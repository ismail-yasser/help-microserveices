apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ingress
  namespace: default
  annotations:
    # This enables regex for the entire Ingress controller's rules
    nginx.ingress.kubernetes.io/use-regex: 'true'
    # Using capture group $2 for the rewrite target
    nginx.ingress.kubernetes.io/rewrite-target: /$2
spec:
  ingressClassName: nginx
  rules:
    - host: help-service.local
      http:
        paths:
          - backend:
              service:
                name: help-service
                port:
                  number: 3002
            path: /
            pathType: Prefix
    - host: user-service.local
      http:
        paths:
          - backend:
              service:
                name: user-service
                port:
                  number: 3000
            path: /
            pathType: Prefix
    - host: frontend.local
      http:
        paths:
          # Order matters! More specific (regex) paths first.

          # Path for routing user-service API calls (e.g., frontend.local/api/users/login)
          # The regex (.*) captures everything after /api/users/
          # The rewrite-target: /$1 sends only the captured part to the backend (e.g., /login)
          - path: /api/users/(.*) # Regex in path
            pathType: ImplementationSpecific # <-- MUST BE ImplementationSpecific
            backend:
              service:
                name: user-service
                port:
                  number: 3000
            annotations: # <-- Annotations for this specific path
              nginx.ingress.kubernetes.io/rewrite-target: /$1 # This strips /api/users/

          # Path for routing help-service API calls (e.g., frontend.local/api/help/tickets)
          - path: /api/help/(.*) # Regex in path
            pathType: ImplementationSpecific # <-- MUST BE ImplementationSpecific
            backend:
              service:
                name: help-service
                port:
                  number: 3002
            annotations: # <-- Annotations for this specific path
              nginx.ingress.kubernetes.io/rewrite-target: /$1 # This strips /api/help/

          # Path for serving the frontend static files (the React app itself)
          # This must remain Prefix and be placed last.
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 80
